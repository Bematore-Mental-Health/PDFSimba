<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Split PDF Editor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <style>
    #pdfContainer {
      height: 600px;
      overflow-y: auto;
      border: 1px solid #ccc;
    }
    canvas {
      display: block;
      margin: 10px auto;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="row">
      <div class="col-md-7">
        <h4>PDF Viewer</h4>
        <div id="pdfContainer"></div>
      </div>
      <div class="col-md-5">
        <h4>Split Options</h4>
        <div class="mb-3">
          <label for="splitAfter" class="form-label">Split after every n pages:</label>
          <input type="number" id="splitAfter" class="form-control" placeholder="Enter n (e.g., 3)">
        </div>
        <div class="mb-3">
          <label for="rangeStart" class="form-label">Save range:</label>
          <input type="number" id="rangeStart" class="form-control mb-2" placeholder="From page">
          <input type="number" id="rangeEnd" class="form-control" placeholder="To page">
        </div>
        <div class="mb-3">
          <label class="form-label">Save specific pages:</label>
          <input type="text" id="customPages" class="form-control" placeholder="e.g., 1,3,5 or 2-4,6">
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="oddPages">
          <label class="form-check-label" for="oddPages">Save odd pages only</label>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="evenPages">
          <label class="form-check-label" for="evenPages">Save even pages only</label>
        </div>
        <button id="splitPDF" class="btn btn-primary">Split PDF</button>
        <div class="mt-3" id="downloadLinks"></div>
      </div>
    </div>
  </div>

  <script>
    const filePath = "{{ file_path }}";
    const pdfContainer = document.getElementById("pdfContainer");

    const renderPDF = async (url) => {
      try {
        const pdf = await pdfjsLib.getDocument(url).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const viewport = page.getViewport({ scale: 1 });
          const canvas = document.createElement("canvas");
          canvas.width = viewport.width;
          canvas.height = viewport.height;
          const context = canvas.getContext("2d");
          await page.render({ canvasContext: context, viewport }).promise;
          pdfContainer.appendChild(canvas);
        }
      } catch (error) {
        console.error("Error rendering PDF:", error);
        alert("Failed to load the PDF. Please check the file path and server.");
      }
    };

    renderPDF(filePath);

    document.getElementById("splitPDF").addEventListener("click", () => {
      const splitAfter = document.getElementById("splitAfter").value;
      const rangeStart = document.getElementById("rangeStart").value;
      const rangeEnd = document.getElementById("rangeEnd").value;
      const customPages = document.getElementById("customPages").value;
      const oddPages = document.getElementById("oddPages").checked;
      const evenPages = document.getElementById("evenPages").checked;

      const splitOptions = {
        filePath: filePath,
        splitAfter: splitAfter ? parseInt(splitAfter, 10) : null,
        rangeStart: rangeStart ? parseInt(rangeStart, 10) : null,
        rangeEnd: rangeEnd ? parseInt(rangeEnd, 10) : null,
        customPages: customPages ? customPages.split(',').map(p => p.includes('-') ? p.split('-').map(Number) : parseInt(p, 10)) : null,
        oddPages: oddPages,
        evenPages: evenPages,
      };

      fetch("http://127.0.0.1:5000/split-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(splitOptions),
      })
        .then(response => response.json())
        .then(data => {
          if (data.error) throw new Error(data.error);
          const downloadLinks = document.getElementById("downloadLinks");
          downloadLinks.innerHTML = '';
          data.output_files.forEach(file => {
            const link = document.createElement("a");
            link.href = file;
            link.textContent = `Download ${file}`;
            link.style.display = "block";
            downloadLinks.appendChild(link);
          });
        })
        .catch(error => alert("Error: " + error.message));
    });
  </script>
</body>
</html>
